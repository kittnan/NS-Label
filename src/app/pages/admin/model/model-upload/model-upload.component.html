<div class="model-upload-container">
    <h2>Model Upload & Compare</h2>

    <!-- Upload Section -->
    <div class="upload-section">
        <div class="upload-row">
            <!-- TSV File Upload -->
            <div class="upload-item">
                <label class="upload-label">TSV File (.tsv)</label>
                <input type="file" accept=".tsv" (change)="onFileSelect($event, 'tsv')" #tsvFileInput hidden />
                <button mat-raised-button color="primary" (click)="tsvFileInput.click()" class="upload-btn">
                    <mat-icon>upload_file</mat-icon>
                    Upload FVCF003 (TSV)
                </button>
                <span class="file-name" *ngIf="tsvFile">{{ tsvFile.name }}</span>
                <mat-icon class="check-icon" *ngIf="tsvFile" color="accent">check_circle</mat-icon>
            </div>

            <!-- TXT File Upload -->
            <div class="upload-item">
                <label class="upload-label">TXT File (.txt)</label>
                <input type="file" accept=".txt" (change)="onFileSelect($event, 'txt')" #txtFileInput hidden />
                <button mat-raised-button color="accent" (click)="txtFileInput.click()" class="upload-btn">
                    <mat-icon>upload_file</mat-icon>
                    Upload PKTA117 (TXT)
                </button>
                <span class="file-name" *ngIf="txtFile">{{ txtFile.name }}</span>
                <mat-icon class="check-icon" *ngIf="txtFile" color="accent">check_circle</mat-icon>
            </div>

            <!-- Compare Button -->
            <div class="upload-item">
                <label class="upload-label">Compare Files</label>
                <button mat-raised-button color="accent" (click)="compareFiles()"
                    [disabled]="!tsvFile || !txtFile || isComparing" class="compare-btn">
                    <mat-icon>compare</mat-icon>
                    {{ isComparing ? 'Comparing...' : 'Compare' }}
                </button>
            </div>
        </div>

        <!-- Error Message -->
        <div class="error-message" *ngIf="errorMessage">
            <mat-icon color="warn">error</mat-icon>
            <span>{{ errorMessage }}</span>
        </div>
    </div>

    <!-- Custom Conditions Section -->
    <div class="conditions-section">
        <h3>Custom Conditions (Optional)</h3>
        <p class="conditions-description">Set default values for remarks and unit. These will be applied to all rows.</p>
        
        <div class="conditions-row">
            <mat-form-field appearance="outline" class="condition-field">
                <mat-label>Remark 1</mat-label>
                <input matInput [(ngModel)]="customConditions.remark1" placeholder="Enter remark 1">
            </mat-form-field>

            <mat-form-field appearance="outline" class="condition-field">
                <mat-label>Remark 2</mat-label>
                <input matInput [(ngModel)]="customConditions.remark2" placeholder="Enter remark 2">
            </mat-form-field>

            <mat-form-field appearance="outline" class="condition-field">
                <mat-label>Remark 3</mat-label>
                <input matInput [(ngModel)]="customConditions.remark3" placeholder="Enter remark 3">
            </mat-form-field>

            <mat-form-field appearance="outline" class="condition-field">
                <mat-label>Unit</mat-label>
                <input matInput [(ngModel)]="customConditions.unit" placeholder="Enter unit">
            </mat-form-field>
        </div>

        <h3 class="filter-title">TSV Filter Conditions</h3>
        <p class="conditions-description">Set filter values for TSV columns. Leave empty to include all rows. Use OR to match any condition, AND to require all conditions.</p>
        
        <div class="filter-list">
            <div class="filter-item" *ngFor="let filter of filterConditions; let i = index">
                <mat-form-field appearance="outline" class="filter-operator-field">
                    <mat-label>Logic</mat-label>
                    <mat-select [(ngModel)]="filter.operator">
                        <mat-option value="OR">OR</mat-option>
                        <mat-option value="AND">AND</mat-option>
                    </mat-select>
                    <mat-hint>Operator</mat-hint>
                </mat-form-field>

                <mat-form-field appearance="outline" class="filter-column-field">
                    <mat-label>Column</mat-label>
                    <input matInput [(ngModel)]="filter.column" placeholder="e.g., AG" [style.text-transform]="'uppercase'">
                    <mat-hint>Column address</mat-hint>
                </mat-form-field>

                <mat-form-field appearance="outline" class="filter-value-field">
                    <mat-label>Value</mat-label>
                    <input matInput [(ngModel)]="filter.value" placeholder="e.g., N3893">
                    <mat-hint>Expected value</mat-hint>
                </mat-form-field>

                <button mat-icon-button color="warn" (click)="removeFilterCondition(i)" 
                        [disabled]="filterConditions.length <= 1"
                        class="remove-filter-btn"
                        matTooltip="Remove filter">
                    <mat-icon>delete</mat-icon>
                </button>
            </div>

            <button mat-raised-button color="accent" (click)="addFilterCondition()" class="add-filter-btn">
                <mat-icon>add</mat-icon>
                Add Filter Condition
            </button>
        </div>
    </div>

    <!-- Comparison Result Table -->
    <div class="result-section" *ngIf="resultData.length > 0">
        <h3>Result Data</h3>

        <!-- Statistics -->
        <div class="statistics-panel">
            <div class="stat-item success">
                <mat-icon>check_circle</mat-icon>
                <div class="stat-content">
                    <span class="stat-number">{{ resultWithPartName.length }}</span>
                    <span class="stat-label">With Part Name (Will Submit)</span>
                </div>
            </div>
            <div class="stat-item warning">
                <mat-icon>warning</mat-icon>
                <div class="stat-content">
                    <span class="stat-number">{{ resultWithoutPartName.length }}</span>
                    <span class="stat-label">Without Part Name (Will Skip)</span>
                </div>
            </div>
            <div class="stat-item info">
                <mat-icon>list</mat-icon>
                <div class="stat-content">
                    <span class="stat-number">{{ resultData.length }}</span>
                    <span class="stat-label">Total Rows</span>
                </div>
            </div>
        </div>

        <div class="loading-indicator" *ngIf="isFetchingPartNames">
            <mat-spinner diameter="30"></mat-spinner>
            <span>Fetching part names...</span>
        </div>

        <div class="table-container">
            <table mat-table [dataSource]="resultData" class="comparison-table">

                <!-- Index Column -->
                <ng-container matColumnDef="index">
                    <th mat-header-cell *matHeaderCellDef>No.</th>
                    <td mat-cell *matCellDef="let row">{{ row.index }}</td>
                </ng-container>

                <!-- SO Column -->
                <ng-container matColumnDef="SO">
                    <th mat-header-cell *matHeaderCellDef>SO</th>
                    <td mat-cell *matCellDef="let row">
                        <input type="text" [(ngModel)]="row.SO" (change)="onCellEdit(row, 'SO')"
                            class="editable-cell" />
                    </td>
                </ng-container>

                <!-- Internal Model Column -->
                <ng-container matColumnDef="internalModel">
                    <th mat-header-cell *matHeaderCellDef>Internal Model</th>
                    <td mat-cell *matCellDef="let row">
                        <input type="text" [(ngModel)]="row.internalModel" (change)="onCellEdit(row, 'internalModel')"
                            class="editable-cell" />
                    </td>
                </ng-container>

                <!-- Part Name Column -->
                <ng-container matColumnDef="partName">
                    <th mat-header-cell *matHeaderCellDef>Part Name</th>
                    <td mat-cell *matCellDef="let row">
                        <input type="text" [(ngModel)]="row.partName" (change)="onCellEdit(row, 'partName')"
                            class="editable-cell" [class.missing]="!row.hasPartName" />
                    </td>
                </ng-container>

                <!-- Seiden Column -->
                <ng-container matColumnDef="seiden">
                    <th mat-header-cell *matHeaderCellDef>Seiden</th>
                    <td mat-cell *matCellDef="let row">
                        <input type="text" [(ngModel)]="row.seiden" (change)="onCellEdit(row, 'seiden')"
                            class="editable-cell" />
                    </td>
                </ng-container>

                <!-- Model Name Column -->
                <ng-container matColumnDef="modelName">
                    <th mat-header-cell *matHeaderCellDef>Model Name</th>
                    <td mat-cell *matCellDef="let row">
                        <input type="text" [(ngModel)]="row.modelName" (change)="onCellEdit(row, 'modelName')"
                            class="editable-cell" />
                    </td>
                </ng-container>

                <!-- Type Column -->
                <ng-container matColumnDef="type">
                    <th mat-header-cell *matHeaderCellDef>Type</th>
                    <td mat-cell *matCellDef="let row">
                        <select [(ngModel)]="row.type" (change)="onCellEdit(row, 'type')" class="editable-cell">
                            <option value="mass">mass</option>
                            <option value="prelaunch">prelaunch</option>
                        </select>
                    </td>
                </ng-container>

                <!-- Remark1 Column -->
                <ng-container matColumnDef="remark1">
                    <th mat-header-cell *matHeaderCellDef>Remark 1</th>
                    <td mat-cell *matCellDef="let row">
                        <input type="text" [(ngModel)]="row.remark1" (change)="onCellEdit(row, 'remark1')"
                            class="editable-cell" />
                    </td>
                </ng-container>

                <!-- Remark2 Column -->
                <ng-container matColumnDef="remark2">
                    <th mat-header-cell *matHeaderCellDef>Remark 2</th>
                    <td mat-cell *matCellDef="let row">
                        <input type="text" [(ngModel)]="row.remark2" (change)="onCellEdit(row, 'remark2')"
                            class="editable-cell" />
                    </td>
                </ng-container>

                <!-- Remark3 Column -->
                <ng-container matColumnDef="remark3">
                    <th mat-header-cell *matHeaderCellDef>Remark 3</th>
                    <td mat-cell *matCellDef="let row">
                        <input type="text" [(ngModel)]="row.remark3" (change)="onCellEdit(row, 'remark3')"
                            class="editable-cell" />
                    </td>
                </ng-container>

                <!-- PO Column -->
                <ng-container matColumnDef="po">
                    <th mat-header-cell *matHeaderCellDef>PO</th>
                    <td mat-cell *matCellDef="let row">
                        <input type="text" [(ngModel)]="row.po" (change)="onCellEdit(row, 'po')"
                            class="editable-cell" />
                    </td>
                </ng-container>

                <!-- Unit Column -->
                <ng-container matColumnDef="unit">
                    <th mat-header-cell *matHeaderCellDef>Unit</th>
                    <td mat-cell *matCellDef="let row">
                        <input type="text" [(ngModel)]="row.unit" (change)="onCellEdit(row, 'unit')"
                            class="editable-cell" />
                    </td>
                </ng-container>

                <!-- Status Column -->
                <ng-container matColumnDef="status">
                    <th mat-header-cell *matHeaderCellDef>Status</th>
                    <td mat-cell *matCellDef="let row">
                        <span class="status-badge" [class.valid]="row.hasPartName" [class.invalid]="!row.hasPartName">
                            <mat-icon>{{ row.hasPartName ? 'check_circle' : 'cancel' }}</mat-icon>
                            {{ row.hasPartName ? 'Valid' : 'Missing Part' }}
                        </span>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;" 
                    [class.row-valid]="row.hasPartName" 
                    [class.row-invalid]="!row.hasPartName"></tr>
            </table>
        </div>

        <!-- Submit Button -->
        <div class="submit-section">
            <button mat-raised-button color="primary" (click)="onSubmit()" 
                    [disabled]="isSubmitting || resultWithPartName.length === 0" 
                    class="submit-btn">
                <mat-icon>save</mat-icon>
                {{ isSubmitting ? 'Submitting...' : 'Submit (' + resultWithPartName.length + ' rows)' }}
            </button>
        </div>

        <!-- Success Message -->
        <div class="success-message" *ngIf="successMessage">
            <mat-icon color="primary">check_circle</mat-icon>
            <span>{{ successMessage }}</span>
        </div>
    </div>
</div>